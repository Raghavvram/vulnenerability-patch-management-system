{
  "dashboard": {
    "id": null,
    "uid": "cet2672zyhe68f",
    "title": "Vulnerability Management - NIST Compliance",
    "tags": ["vulnerability", "nist", "patch-management"],
    "timezone": "browser",
    "schemaVersion": 37,
    "version": 1,
    "refresh": "1m",
    "panels": [
      {
        "id": 1,
        "title": "NIST SI-2 Overall Compliance",
        "type": "stat",
        "gridPos": { "h": 8, "w": 6, "x": 0, "y": 0 },
        "fieldConfig": {
          "defaults": {
            "color": { "mode": "thresholds" },
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "red", "value": 0 },
                { "color": "yellow", "value": 70 },
                { "color": "green", "value": 90 }
              ]
            },
            "unit": "percent",
            "min": 0,
            "max": 100,
            "decimals": 1
          }
        },
        "options": {
          "textMode": "auto",
          "colorMode": "background"
        },
        "targets": [
          {
            "datasource": { "type": "postgres", "uid": "grafana-postgresql-datasource" },
            "rawSql": "SELECT ROUND((COUNT(*) FILTER (WHERE status='remediated') * 100.0) / NULLIF(COUNT(*),0),1) as compliance_percentage FROM vulnerabilities WHERE discovered_at >= NOW() - INTERVAL '30 days'",
            "format": "time_series",
            "refId": "A"
          }
        ]
      },
      {
        "id": 2,
        "title": "Critical Vulnerabilities Status",
        "type": "piechart",
        "gridPos": { "h": 8, "w": 6, "x": 6, "y": 0 },
        "options": {
          "pieType": "pie",
          "legend": { "displayMode": "list", "placement": "bottom" }
        },
        "targets": [
          {
            "datasource": { "type": "postgres", "uid": "grafana-postgresql-datasource" },
            "rawSql": "SELECT status, COUNT(*) as count FROM vulnerabilities WHERE priority='Critical' GROUP BY status",
            "format": "table",
            "refId": "B"
          }
        ]
      },
      {
        "id": 3,
        "title": "Mean Time to Patch (MTTP) Trend",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
        "fieldConfig": {
          "defaults": {
            "unit": "h",
            "min": 0,
            "color": { "mode": "palette-classic" }
          }
        },
        "options": {
          "legend": { "displayMode": "table", "placement": "bottom" },
          "tooltip": { "mode": "multi" }
        },
        "targets": [
          {
            "datasource": { "type": "postgres", "uid": "grafana-postgresql-datasource" },
            "rawSql": "SELECT date_trunc('day', remediated_at) as time, priority, AVG(EXTRACT(EPOCH FROM (remediated_at - discovered_at))/3600) as avg_mttp_hours FROM vulnerabilities WHERE remediated_at IS NOT NULL AND remediated_at >= NOW() - INTERVAL '30 days' GROUP BY time, priority ORDER BY time",
            "format": "time_series",
            "refId": "C"
          }
        ]
      },
      {
        "id": 4,
        "title": "CVSS vs EPSS Risk Matrix",
        "type": "scatterplot",
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
        "fieldConfig": {
          "defaults": {
            "color": { "mode": "continuous-GrYlRd" }
          }
        },
        "options": {
          "tooltip": { "mode": "single" }
        },
        "targets": [
          {
            "datasource": { "type": "postgres", "uid": "grafana-postgresql-datasource" },
            "rawSql": "SELECT cvss_score AS x, epss_score AS y, COUNT(*) AS z, priority FROM vulnerabilities WHERE status = 'open' GROUP BY cvss_score, epss_score, priority ORDER BY cvss_score, epss_score",
            "format": "table",
            "refId": "D"
          }
        ]
      },
      {
        "id": 5,
        "title": "SLA Breach Count",
        "type": "stat",
        "gridPos": { "h": 4, "w": 6, "x": 12, "y": 0 },
        "fieldConfig": {
          "defaults": {
            "color": { "mode": "thresholds" },
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": 0 },
                { "color": "red", "value": 1 }
              ]
            },
            "min": 0
          }
        },
        "options": {
          "textMode": "auto",
          "colorMode": "value"
        },
        "targets": [
          {
            "datasource": { "type": "postgres", "uid": "grafana-postgresql-datasource" },
            "rawSql": "SELECT COUNT(*) AS sla_breach_count FROM vulnerabilities WHERE status = 'open' AND (discovered_at + INTERVAL '1 hour' * CASE priority WHEN 'Critical' THEN 24 WHEN 'High' THEN 72 WHEN 'Medium' THEN 120 ELSE 168 END) < NOW()",
            "format": "time_series",
            "refId": "E"
          }
        ]
      },
      {
        "id": 6,
        "title": "Open Vulnerabilities by Priority",
        "type": "barchart",
        "gridPos": { "h": 4, "w": 6, "x": 18, "y": 0 },
        "fieldConfig": {
          "defaults": {
            "unit": "none",
            "color": { "mode": "palette-classic" }
          }
        },
        "options": {
          "legend": { "displayMode": "table", "placement": "bottom" }
        },
        "targets": [
          {
            "datasource": { "type": "postgres", "uid": "grafana-postgresql-datasource" },
            "rawSql": "SELECT priority, COUNT(*) AS open_count FROM vulnerabilities WHERE status = 'open' GROUP BY priority ORDER BY CASE priority WHEN 'Critical' THEN 1 WHEN 'High' THEN 2 WHEN 'Medium' THEN 3 ELSE 4 END",
            "format": "table",
            "refId": "F"
          }
        ]
      }
    ],
    "templating": {
      "list": []
    },
    "time": {
      "from": "now-30d",
      "to": "now"
    }
  }
}
